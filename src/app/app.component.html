<div class="dashboard-container">
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <div class="logo">
          <span class="logo-icon">ğŸ“</span>
          <h1>Dashboard IoT - SalÃ³n de Clases</h1>
        </div>
        <p class="subtitle">Control inteligente con Alexa</p>
      </div>
      <div class="header-right">
        <div class="time-display">
          <span class="time">{{ currentTime | date: 'HH:mm:ss' }}</span>
          <span class="date">{{ currentTime | date: 'dd/MM/yyyy' }}</span>
        </div>
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span>Sistema Activo</span>
        </div>
        <button class="api-config-button" (click)="toggleApiConfig()" title="Configurar API">
          âš™ï¸
        </button>
      </div>
    </div>
    
    <!-- Panel de ConfiguraciÃ³n de API -->
    <div class="api-config-panel" [class.show]="showApiConfig">
      <div class="api-config-content">
        <h3>âš™ï¸ ConfiguraciÃ³n de API</h3>
        <p class="config-description">Configura la URL base de tu API para conectar con los sensores reales</p>
        
        <div class="input-group">
          <label for="apiUrl">URL de la API:</label>
          <input 
            type="text" 
            id="apiUrl"
            [(ngModel)]="apiUrl" 
            placeholder="http://172.20.10.2:8000"
            class="api-input"
          />
        </div>
        
        <div class="data-source-toggle">
          <label class="toggle-label">
            <input 
              type="checkbox" 
              [(ngModel)]="useRealData" 
              (change)="toggleDataSource()"
              class="toggle-checkbox"
            />
            <span class="toggle-switch"></span>
            <span class="toggle-text">
              {{ useRealData ? 'ğŸ”´ Datos Reales (SSE)' : 'ğŸŸ¢ Datos Simulados' }}
            </span>
          </label>
          <p class="toggle-description">
            {{ useRealData ? 'Conectado al servidor mediante Server-Sent Events' : 'Usando datos de prueba generados localmente' }}
          </p>
        </div>
        
        <div class="config-actions">
          <button class="btn-save" (click)="saveApiUrl()">
            ğŸ’¾ Guardar
          </button>
          <button class="btn-reset" (click)="resetApiUrl()">
            ğŸ”„ Restablecer
          </button>
          <button class="btn-cancel" (click)="toggleApiConfig()">
            âœ–ï¸ Cancelar
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Sensors Section -->
    <section class="section">
      <h2 class="section-title">
        <span class="title-icon">ğŸ“Š</span>
        Mediciones en Tiempo Real
      </h2>
      <div class="sensors-grid">
        <div *ngFor="let sensor of sensors" class="sensor-card" [attr.data-status]="sensor.status">
          <div class="card-header">
            <div class="sensor-icon">{{ sensor.icon }}</div>
            <div class="sensor-info">
              <h3>{{ sensor.name }}</h3>
              <span class="timestamp">{{ sensor.timestamp | date: 'HH:mm:ss' }}</span>
            </div>
            <div class="status-badge" [style.background-color]="getStatusColor(sensor.status)">
              {{ getStatusText(sensor.status) }}
            </div>
          </div>
          
          <div class="sensor-value">
            <span class="value">{{ sensor.value }}</span>
            <span class="unit">{{ sensor.unit }}</span>
          </div>

          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" 
                   [style.width.%]="getPercentage(sensor)"
                   [style.background-color]="getStatusColor(sensor.status)">
              </div>
            </div>
            <div class="progress-labels">
              <span>{{ sensor.min }}{{ sensor.unit }}</span>
              <span>{{ sensor.max }}{{ sensor.unit }}</span>
            </div>
          </div>

          <!-- GrÃ¡fico de Serie Temporal -->
          <div class="chart-container" *ngIf="sensor.history && sensor.history.length > 0">
            <div class="chart-title">ğŸ“ˆ Serie Temporal - Ãšltimas 10 mediciones</div>
            <div class="time-series-chart">
              <div class="y-axis">
                <span class="y-label">{{ sensor.max }}</span>
                <span class="y-label y-mid">{{ ((sensor.max + sensor.min) / 2).toFixed(0) }}</span>
                <span class="y-label">{{ sensor.min }}</span>
              </div>
              <div class="chart-area">
                <svg class="line-chart" [attr.viewBox]="'0 0 ' + (sensor.history.length * 50) + ' 100'" preserveAspectRatio="none">
                  <!-- LÃ­neas de cuadrÃ­cula -->
                  <line x1="0" y1="0" [attr.x2]="sensor.history.length * 50" y2="0" class="grid-line" />
                  <line x1="0" y1="50" [attr.x2]="sensor.history.length * 50" y2="50" class="grid-line" />
                  <line x1="0" y1="100" [attr.x2]="sensor.history.length * 50" y2="100" class="grid-line" />
                  
                  <!-- Ãrea bajo la lÃ­nea -->
                  <defs>
                    <linearGradient [id]="'gradient-' + sensor.id" x1="0%" y1="0%" x2="0%" y2="100%">
                      <stop offset="0%" [attr.stop-color]="getStatusColor(sensor.status)" stop-opacity="0.3"/>
                      <stop offset="100%" [attr.stop-color]="getStatusColor(sensor.status)" stop-opacity="0.05"/>
                    </linearGradient>
                  </defs>
                  <path 
                    [attr.d]="getAreaPath(sensor.history, sensor.min, sensor.max)"
                    [attr.fill]="'url(#gradient-' + sensor.id + ')'"
                  />
                  
                  <!-- LÃ­nea principal -->
                  <polyline
                    [attr.points]="getPolylinePoints(sensor.history, sensor.min, sensor.max)"
                    [attr.stroke]="getStatusColor(sensor.status)"
                    stroke-width="2"
                    fill="none"
                    class="chart-line"
                  />
                  
                  <!-- Puntos de datos -->
                  <circle
                    *ngFor="let value of sensor.history; let i = index"
                    [attr.cx]="(i * 50) + 25"
                    [attr.cy]="100 - getChartHeight(value, sensor.min, sensor.max)"
                    r="4"
                    [attr.fill]="getStatusColor(getStatusForValue(sensor.id, value))"
                    class="data-point"
                    [attr.data-value]="value"
                  >
                    <title>{{ value }} {{ sensor.unit }}</title>
                  </circle>
                </svg>
                <div class="x-axis">
                  <span *ngFor="let value of sensor.history; let i = index" class="x-label">
                    {{ i + 1 }}
                  </span>
                </div>
              </div>
            </div>
            <div class="chart-legend">
              <span class="legend-item">
                <span class="legend-dot" style="background: #10b981;"></span>
                Normal
              </span>
              <span class="legend-item">
                <span class="legend-dot" style="background: #f59e0b;"></span>
                Alerta
              </span>
              <span class="legend-item">
                <span class="legend-dot" style="background: #ef4444;"></span>
                CrÃ­tico
              </span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Devices Section -->
    <section class="section">
      <h2 class="section-title">
        <span class="title-icon">âš™ï¸</span>
        Control de Dispositivos
      </h2>
      <div class="devices-grid">
        <div *ngFor="let device of devices" class="device-card">
          <div class="card-header">
            <div class="device-icon">{{ device.icon }}</div>
            <div class="device-info">
              <h3>{{ device.name }}</h3>
              <span class="timestamp">{{ device.lastUpdate | date: 'HH:mm:ss' }}</span>
            </div>
          </div>

          <div class="device-status">
            <div class="status-badge-large" [style.background-color]="getStatusColor(device.status)">
              {{ getStatusText(device.status) }}
            </div>
          </div>

          <div class="device-visual">
            <div *ngIf="device.type === 'blinds'" class="blinds-visual">
              <div class="blinds-container">
                <div class="blinds-level" [style.height.%]="device.level"></div>
              </div>
            </div>
            <div *ngIf="device.type === 'fan'" class="fan-visual">
              <div class="fan-blades" 
                   [class.spinning]="device.status === 'on'"
                   [style.animation-duration]="(100 / (device.level || 1)) + 's'">
                ğŸŒ€
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Info Section -->
    <section class="section info-section">
      <div class="info-card">
        <div class="info-icon">ğŸ¤</div>
        <div class="info-content">
          <h3>Control por Voz</h3>
          <p>Utiliza comandos de Alexa para controlar las persianas y el ventilador del salÃ³n</p>
        </div>
      </div>
      <div class="info-card">
        <div class="info-icon">ğŸ””</div>
        <div class="info-content">
          <h3>Alertas AutomÃ¡ticas</h3>
          <p>El sistema te notificarÃ¡ cuando los valores estÃ©n fuera del rango Ã³ptimo</p>
        </div>
      </div>
      <div class="info-card">
        <div class="info-icon">ğŸ“ˆ</div>
        <div class="info-content">
          <h3>Monitoreo Continuo</h3>
          <p>Datos actualizados en tiempo real desde los sensores del salÃ³n</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Chatbot Button -->
  <button class="chat-toggle-btn" (click)="showChat = !showChat" [class.active]="showChat">
    <span *ngIf="!showChat">ğŸ’¬</span>
    <span *ngIf="showChat">âœ•</span>
  </button>

  <!-- Chatbot Panel -->
  <div class="chat-panel" [class.open]="showChat">
    <div class="chat-header">
      <div class="chat-header-info">
        <span class="chat-icon">ğŸ¤–</span>
        <div>
          <h3>Asistente Inteligente</h3>
          <p class="chat-status">En lÃ­nea</p>
        </div>
      </div>
      <button class="chat-close-btn" (click)="showChat = false">âœ•</button>
    </div>

    <div class="chat-messages" #chatMessagesContainer>
      <div *ngIf="chatMessages.length === 0" class="chat-welcome">
        <div class="welcome-icon">ğŸ‘‹</div>
        <h4>Â¡Hola! Soy tu asistente de aula inteligente</h4>
        <p>Puedo ayudarte a controlar los dispositivos del salÃ³n. Por ejemplo:</p>
        <ul>
          <li>"Enciende el ventilador"</li>
          <li>"Abre las persianas"</li>
          <li>"Apaga las luces"</li>
          <li>"Â¿CuÃ¡l es la temperatura actual?"</li>
        </ul>
      </div>

      <div *ngFor="let msg of chatMessages" class="chat-message" [class.user]="msg.sender === 'user'" [class.assistant]="msg.sender === 'assistant'">
        <div class="message-content">
          <div class="message-avatar">
            <span *ngIf="msg.sender === 'user'">ğŸ‘¤</span>
            <span *ngIf="msg.sender === 'assistant'">ğŸ¤–</span>
          </div>
          <div class="message-bubble">
            <p>{{ msg.text }}</p>
            <div *ngIf="msg.response" class="device-updates">
              <div class="update-header">Estado de dispositivos:</div>
              <div class="update-items">
                <span class="update-item" [class.on]="msg.response.ventilador">
                  <span class="device-emoji">ğŸŒ¬ï¸</span> Ventilador: {{ msg.response.ventilador ? 'Encendido' : 'Apagado' }}
                </span>
                <span class="update-item" [class.on]="msg.response.persianas">
                  <span class="device-emoji">ğŸªŸ</span> Persianas: {{ msg.response.persianas ? 'Abiertas' : 'Cerradas' }}
                </span>
                <span class="update-item" [class.on]="msg.response.bulbs">
                  <span class="device-emoji">ğŸ’¡</span> Luces: {{ msg.response.bulbs ? 'Encendidas' : 'Apagadas' }}
                </span>
              </div>
            </div>
            <span class="message-time">{{ msg.timestamp | date: 'HH:mm' }}</span>
          </div>
        </div>
      </div>

      <div *ngIf="isSendingMessage" class="chat-message assistant">
        <div class="message-content">
          <div class="message-avatar">ğŸ¤–</div>
          <div class="message-bubble typing">
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="chat-input-container">
      <input
        type="text"
        class="chat-input"
        placeholder="Escribe tu mensaje..."
        [(ngModel)]="userMessage"
        (keyup.enter)="sendMessage()"
        [disabled]="isSendingMessage"
      />
      <button class="chat-send-btn" (click)="sendMessage()" [disabled]="!userMessage.trim() || isSendingMessage">
        <span *ngIf="!isSendingMessage">ğŸ“¤</span>
        <span *ngIf="isSendingMessage" class="spinner"></span>
      </button>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>Dashboard IoT - Sistema de Control Inteligente para Aulas | 2025</p>
  </footer>
</div>
